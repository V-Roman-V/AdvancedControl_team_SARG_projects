# Advanced Control Methods Project: Motorized Vessel Control

## Overview

This project is focused on the **controlling** of a motorized boat using energy based control.

<img src="images/Boat types.png" alt="Differential vs. steerable thruster configurations" style="width:50%;">

## Task Definition

Given the initial state $\mathbf{x}_i$ and a desired position $\mathbf{x}_d$, the goal is to design a control law $\mathbf{u} = [u_1, u_2]^T$ such that the boat will finish at the desired position with zero velocity.
The boat can finish at any angle. The thruster force can only be applied in the forward direction.


## Mathematical Model

### Boat Kinematics

Let the state vector of the boat be represented as:

$$
\mathbf{x} = \begin{bmatrix} x, & y, & \psi, & V_x, & V_y, & \omega \end{bmatrix}^T,
$$

where:
- $x, y$ are the position coordinates,
- $\psi$ is the yaw (heading),
- $V_x, V_y$ are the surge and sway velocities (linear velocities in the body-fixed frame),
- $\omega$ is the yaw rate.

The boat dynamic equations are in matrix form is following:

<!-- $$
\begin{aligned}
\dot{x} &= V_x \cos(\psi) - V_y \sin(\psi), \\
\dot{y} &= V_x \sin(\psi) + V_y \cos(\psi), \\
\dot{\psi} &= \omega, \\
\dot{V}_x &= \frac{1}{m}\left(F_x(u)\right) - D_x V_x, \\
\dot{V}_y &= \frac{1}{m}\left(F_y(u)\right) - D_y V_y, \\
\dot{\omega} &= \frac{1}{I_z} \left( M(u) \right) - D_ψ \omega
\end{aligned}
$$ -->

$$
\begin{bmatrix}
    \dot{x} \\
    \dot{y} \\
    \dot{\psi} \\
    \dot{V}_x \\
    \dot{V}_y \\
    \dot{\omega}
\end{bmatrix}
= \begin{bmatrix}
0 & 0 & 0 & \cos(\psi) & -\sin(\psi) & 0 \\
0 & 0 & 0 & \sin(\psi) & \cos(\psi) & 0 \\
0 & 0 & 0 & 0 & 0 & 1 \\
0 & 0 & 0 & -D_x & 0 & 0 \\
0 & 0 & 0 & 0 & -D_y & 0 \\
0 & 0 & 0 & 0 & 0 & -D_ψ
\end{bmatrix}
\begin{bmatrix}
    x \\
    y \\
    \psi \\
    V_x \\
    V_y \\
    \omega
\end{bmatrix}
+
\begin{bmatrix}
0 & 0 & 0 \\
0 & 0 & 0 \\
0 & 0 & 0 \\
\frac{1}{m} & 0 & 0 \\
0 & \frac{1}{m} & 0 \\
0 & 0 & \frac{1}{I_z}
\end{bmatrix}
\begin{bmatrix}
F_x(u) \\
F_y(u) \\
M(u)
\end{bmatrix}
$$

where:
- $m$ is the boat's mass,
- $I_z$ is the moment of inertia about the vertical axis,
- $D_x, D_y, D_\psi$ are the damping coefficients,
- $F_x, F_y$ are the forces due to the thrusters, and
- $M$ is the moment generated by the thrusters.

#### Differential Drive Boat:

$$
\begin{aligned}
F_x(u) &= u_1 + u_2\\
F_y(u) &= 0 \\
M(u) &= L(u_1 - u_2)
\end{aligned}
$$

where:
- $u_1$ and $u_2$ are the control inputs for the left and right motors, respectively.
- $L$ is the distance between the motor and the center of the boat.

#### Steerable Drive Boat:

$$
\begin{aligned}
F_x(u) &= u_f \cos(u_\phi)\\
F_y(u) &= u_f \sin(u_\phi)\\
M(u) &= L \cdot u_f \sin(u_\phi)\\
\end{aligned}
$$

where:
- $u_f$ is the control for the motor.
- $u_\phi$ is the control for the steering angle.
- $L$ is the distance between the motor and the center of the boat.


## Energy-based Control Design

### Lyapunov Function Candidate:
We'll use the total energy with additional potential term as our Lyapunov function:

$$
V = \frac{1}{2}m(V_x^2 + V_y^2) + \frac{1}{2}I_z\omega^2 + \frac{1}{2}k_p(x_e^2 + y_e^2)
$$

The energy consists of three parts:
- Kinetic energy of the linear motion
- Kinetic energy of the rotational motion
- Potential energy (error in position)

Where:
- $x_e = x - x_d$ and $y_e = y - y_d$ are the position errors (in the body-fixed frame)
- $k_p$ is a positive constant like a gravitational constant

### Time Derivative:
$$
\dot{V} = m(V_x\dot{V}_x + V_y\dot{V}_y) + I_z\omega\dot{\omega} + k_p(x_e\dot{x}_e + y_e\dot{y}_e)
$$

Where:
- $\dot{x}_e = V_x$ and $\dot{y}_e = V_y$ when the desired position is fixed

Substituting the boat dynamics into the time derivative of the Lyapunov function:

$$
\dot{V} = m\left(V_x\left(\frac{1}{m}F_x\left(u\right) - D_x V_x\right) + V_y\left(\frac{1}{m}F_y\left(u\right) - D_y V_y\right)\right) + I_z\omega\left(\frac{1}{I_z}  M\left(u\right)  - D_ψ \omega\right) + k_p\left(x_e V_x + y_e V_y\right)
$$

Simplifying gives:

$$
\dot{V} = V_x F_x(u) + V_y F_y(u) + \omega M(u) - m D_x V_x^2 - m D_y V_y^2 - I_z D_ψ \omega^2 + k_p\left(x_e V_x + y_e V_y\right) 
$$

We wants to have $\dot{V} \leq 0$ for all states, simplifying negative terms gives:

$$
\dot{V} = V_x F_x(u) + V_y F_y(u) + \omega M(u) + k_p(x_e V_x + y_e V_y) \leq 0
$$

$$
V_x F_x(u) + V_y F_y(u) + \omega M(u) \leq -k_p(x_e V_x + y_e V_y)
$$


#### Differential Drive Boat:

Given the differential drive dynamic:

$$
\begin{aligned}
F_x(u) &= u_1 + u_2\\
F_y(u) &= 0 \\
M(u) &= L(u_1 - u_2)\\
\end{aligned}
$$

Substituting into the derivative of Lyapunov function gives:

$$
V_x (u_1 + u_2) + \omega L(u_1 - u_2) \leq -k_p(x_e V_x + y_e V_y)
$$


**We can choose the control law as:**

$$
\begin{aligned}
u_1 &= -k_1\frac{k_p}{V_x}(x_e V_x + y_e V_y) - k_2 \omega \\
u_2 &= -k_1\frac{k_p}{V_x}(x_e V_x + y_e V_y) + k_2 \omega
\end{aligned}
$$

**Substituting the control law into the Lyapunov function gives:**

$$
-2k_1 k_p(x_e V_x + y_e V_y) - 2k_2 L \omega^2 \leq -k_p(x_e V_x + y_e V_y)
$$

which is negative semi-definite when $k_1 > \frac{1}{2}, k_2 > 0$.


#### Steerable Drive Boat:

Given the steerable drive dynamic:

$$
\begin{aligned}
F_x(u) &= u_f \cos(u_\phi)\\
F_y(u) &= u_f \sin(u_\phi)\\
M(u) &= L \cdot u_f \sin(u_\phi)\\
\end{aligned}
$$

Substituting into the derivative of Lyapunov function gives:

$$
V_x u_f \cos(u_\phi) + V_y u_f \sin(u_\phi) + \omega L \cdot u_f \sin(u_\phi) \leq -k_p(x_e V_x + y_e V_y)
$$


**We can choose the control law as:**

$$
\begin{aligned}
u_f &= -k_1 \frac{k_p(x_e V_x + y_e V_y)}{\sqrt{V_x^2 + (V_y + \omega L)^2}} \\
u_\phi &= \arctan2(V_y + \omega L, V_x) \\
\end{aligned}
$$

**Substituting the control law into the Lyapunov function gives:**

$$
-k_1k_p(x_e V_x + y_e V_y)\leq -k_p(x_e V_x + y_e V_y)
$$


which is negative semi-definite when $k_1 > 1$.


### Stability Proof:
1. $V$ is positive definite (always ≥ 0, and = 0 only at desired state)
2. $\dot{V}$ is negative semi-definite (≤ 0 for all states)
3. The system is asymptotically stable since $\dot{V} = 0$ only when $V_x = V_y = \omega = 0$


## Repository Structure

### `control.py`

This file contains the `Controller` classes for **Differential** and **Steering** boats, which computes the control inputs based on the boat state, desired state.

### `boat.py`

This file contains two boat classes `DifferentialThrustBoat` and `SteerableThrustBoat` that models boat dynamics, given the current control inputs.

### `visualization.py`

This module provides functions to visualize the boat trajectory and desired position. 
The visualization has three modes: 'gif', 'realtime', 'final'. The 'gif' mode generates a GIF of the boat motion, 'realtime' shows the simulation in real-time, and 'final' displays the final trajectory after the simulation.

### `main.py`

The `main.py` file is the entry point for the simulation. It initializes the boat, sets up the controller, and runs the simulation loop. At each time step, the control inputs are computed, and the boat state is updated. The trajectory is then visualized.

## How to Run

To run the simulation, simply execute the `main.py` file:

```bash
python main.py
```

## Results

### Differential Drive Boat

The differential drive boat simulation showcases the boat's trajectory and the corresponding phase plot for control. The first image represents the boat's trajectory, with the boat maneuvering through the simulation environment. The second image provides the phase plot, illustrating the relationship between the distance to the target and the angle relative to the target. This demonstrates how the boat adjusts its position and orientation to reach the target efficiently.

![Diff boat](images/Traj_differential_1.png)
![Diff boat](images/Phase_differential_1.png)

<!-- ![alt text](simulator/gif/Differential_gif.gif) -->

### Steerable Drive Boat

In contrast, the steerable drive boat simulation shows a different type of control mechanism. The trajectory of the steerable boat is illustrated in the first image, while the second image presents the phase plot, which provides insights into the boat's angular correction and distance adjustments relative to the target.

![Steer boat](images/Steerable_1.png)
![Steer boat](images/Phase_plot_steerable_1.png)
<!-- ![alt text](simulator/gif/Steerable.gif) -->

### 60 boats simulation


This section presents the results of a complex simulation with 60 boats, focusing on both their trajectory and phase plot. The first image illustrates the trajectories of all 60 boats as they move towards their targets, with varied paths demonstrating the efficiency and challenges of collective navigation. The second image features a phase plot that shows how each boat adjusts its distance and angle relative to the target throughout the simulation, providing a clear representation of the coordination among multiple boats.


#### Trajectories simulation

![trajectories](images/Traj_60_boats.png)

#### Phase plot

![Phase plot](images/Phase_plt_60_boats.png)
